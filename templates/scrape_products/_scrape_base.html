{% extends '../_base.html' %}

{% block content %}
    {% block scrape_content %}
        {% block common %}
            <div class="container mt-4">
                <h2>{% block name %}{% endblock name %}</h2>
                <form method="post" class="mt-4" id="scraperForm">
                    {% csrf_token %}
                    <!-- Scraping Functions Card -->
                    <div class="row mt-1">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <div>Scraping Options</div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="form-group mb-3">
                                            <label for="category_id" title="Select a product category to scrape">Category:</label>
                                            <select class="form-control" id="category_id" name="category_id" required
                                                    onchange="updateFilenames(this.value)">
                                                {% for category in categories %}
                                                <option value="{{ category.id }}">{{ category.name }} ({{ category.id }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="get_categories" name="get_categories"
                                                       {% if defaults.get_categories %}checked{% endif %}>
                                                <label class="form-check-label" for="get_categories" title="Check to enable scraping of product URLs from the selected category">1. Get Categories List</label>
                                            </div>
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="scrape_products" name="scrape_products"
                                                       {% if defaults.scrape_products %}checked{% endif %}>
                                                <label class="form-check-label" for="scrape_products" title="Check to enable scraping of product URLs from the selected category">2. Get Product URLs</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="process_csv" name="process_csv"
                                                       {% if defaults.process_csv %}checked{% endif %}>
                                                <label class="form-check-label" for="process_csv" title="Process the URLs in the specified CSV file to extract product data">3. Process URLs</label>
                                            </div>
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="reprocess_csv" name="reprocess_csv"
                                                       {% if defaults.reprocess_csv %}checked{% endif %}>
                                                <label class="form-check-label" for="reprocess_csv" title="Only process URLs that haven't been processed yet (not found in results)">4. Processes URLS not in Results</label>
                                            </div>
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="process_extra" name="process_extra"
                                                       {% if defaults.process_csv %}checked{% endif %}>
                                                <label class="form-check-label" for="process_extra" title="Reprocess the data file to extract extra data">Process Extra Data</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="url_file" title="Name of the CSV file containing product URLs (will be auto-filled based on category)">URLs CSV File:</label>
                                                <input type="text" class="form-control" id="url_file" name="url_file"
                                                       value="{{ defaults.url_file }}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="data_file" title="Name of the CSV file where product data will be saved (will be auto-filled based on category)">Data CSV File:</label>
                                                <input type="text" class="form-control" id="data_file" name="data_file"
                                                       value="{{ defaults.data_file }}">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <button type="submit" class="btn btn-primary mt-3">Run</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- CSV Functions Card -->
                    <div class="row mt-1">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <div>CSV Functions</div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="dedupe_csv" name="dedupe_csv"
                                                       {% if defaults.dedupe_csv %}checked{% endif %}>
                                                <label class="form-check-label" for="dedupe_csv"
                                                       title="Remove duplicate entries from the specified CSV file (use URL Filename field)">
                                                    Dedupe a CSV
                                                </label>
                                            </div>
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="count_csv" name="count_csv"
                                                       {% if defaults.count_csv %}checked{% endif %}>
                                                <label class="form-check-label" for="count_csv"
                                                       title="Count rows in all  CSV files in the specified directory">
                                                    Count Rows in All CSVs in home directory
                                                </label>
                                            </div>
                                            <button type="submit" class="btn btn-primary mt-3">Run</button>
                                        </div>
                                        <div class="col-md-6">
{#                                            <div class="form-group">#}
{#                                                <label for="distributor_name" class="form-label">Distributor Name:</label>#}
{#                                                <div class="input-group">#}
{#                                                    <input type="text" class="form-control" id="distributor_name"#}
{#                                                           placeholder="Enter distributor name">#}
{#                                                    <button class="btn btn-outline-secondary" type="button"#}
{#                                                            id="#test">#}
{#                                                        Update All CSVs#}
{#                                                    </button>#}
{#                                                </div>#}
{#                                                <small class="form-text text-muted">#}
{#                                                    Updates the 'distributor_name' column in all CSV files in the home directory.#}
{#                                                </small>#}
{#                                            </div>#}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- General Configuration Card -->
                    <div class="row mt-1">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <div>General Configuration</div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="home_directory" title="Base directory where files will be saved (defaults to current directory)">Home Directory:</label>
                                                <input type="text" class="form-control" id="home_directory" name="home_directory"
                                                       value="{{ defaults.home_directory|default:'.' }}" placeholder="Enter home directory path">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="max_products" title="Maximum number of products to request from the API in a single call">Max Products to Force in API Call:</label>
                                                <input type="number" class="form-control" id="max_products" name="max_products"
                                                       value="{{ defaults.max_products }}" min="1">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Testing Card -->
                    <div class="row mt-1">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <div>Target a specific category or row</div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="start_row" title="Start processing from this row number (0-based index)">Start Row:</label>
                                                <input type="number" class="form-control" id="start_row" name="start_row"
                                                       value="{{ defaults.start_row }}" min="0">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="category_to_process" title="Process only this specific category (0 = process all categories)">Category to Process: </label>
                                                <input type="number" class="form-control" id="category_to_process" name="category_to_process"
                                                       value="{{ defaults.category_to_process }}" min="0">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="test_products" title="Maximum number of products to scrape (for testing purposes)">Number of Products to Scrape:</label>
                                <input type="number" class="form-control" id="test_products" name="test_products"
                                       value="{{ defaults.test_products }}" min="1">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="test_categories" title="Maximum number of categories to process (for testing purposes)">Number of Categories to Scrape:</label>
                                <input type="number" class="form-control" id="test_categories" name="test_categories"
                                       value="{{ defaults.test_categories }}" min="1">
                            </div>
                        </div>
                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Utilities Card -->
                    <div class="row mt-1">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <div>Utilities</div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="row mb-4">
                                            <div class="col-md-12">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <div>Update Distributor Name</div>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col-md-8">
                                                                <div class="form-group">
                                                                    <label for="distributor_name" class="form-label">Distributor Name:</label>
                                                                    <div class="input-group">
                                                                        <input type="text" class="form-control" id="distributor_name"
                                                                               placeholder="Enter distributor name">
                                                                        <button type="button" class="btn btn-primary" id="update_distributor_btn">
                                                                            <i class="bi bi-tag"></i> Update Distributor
                                                                        </button>
                                                                    </div>
                                                                    <small class="form-text text-muted">
                                                                        This will update/add the 'distributor_name' column in all CSV files in the home directory.
                                                                    </small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div id="distributor_results" class="mt-3" style="display: none;">
                                                            <div class="alert alert-success" id="distributor_success" style="display: none;"></div>
                                                            <div class="alert alert-danger" id="distributor_error" style="display: none;"></div>
                                                            <div id="distributor_details" style="display: none;">
                                                                <p class="mb-1"><strong>Updated files:</strong> <span id="updated_files_count">0</span></p>
                                                                <p class="mb-1"><strong>Total files processed:</strong> <span id="total_files_count">0</span></p>
                                                                <div id="distributor_errors" class="mt-2" style="display: none;">
                                                                    <h6>Errors:</h6>
                                                                    <ul id="error_list" class="text-danger small"></ul>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div id="distributor_loading" class="text-center my-3" style="display: none;">
                                                            <div class="spinner-border text-primary" role="status">
                                                                <span class="visually-hidden">Loading...</span>
                                                            </div>
                                                            <p class="mt-2">Updating distributor names, please wait...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                        <div class="col-md-12">
                                            <div class="card mb-4">
                                                <div class="card-header">
                                                    <div>CSV Row Counter</div>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-8">
                                                            <div class="form-group">
                                                                <label for="csv_dir" class="form-label">Directory to Scan:</label>
                                                                <div class="input-group">
                                                                    <input type="text" class="form-control" id="csv_dir" name="csv_dir"
                                                                           placeholder="Enter directory path" value="{{ defaults.home_directory|default:'.' }}">
                                                                    <button type="button" class="btn btn-primary" id="count_csv_btn">
                                                                        <i class="bi bi-calculator"></i> Count Rows</button>
                                                                </div>
                                                                <small class="form-text text-muted">
                                                                    Will scan all subdirectories for CSV files containing 'data' in their names.
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div id="csv_results" class="mt-3" style="display: none;">
                                                        <div class="table-responsive">
                                                            <table class="table table-sm table-striped">
                                                                <thead class="table-light">
                                                                    <tr>
                                                                        <th>Directory</th>
                                                                        <th>File</th>
                                                                        <th class="text-end">Rows</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="csv_results_body">
                                                                    <!-- Results will be inserted here by JavaScript -->
                                                                </tbody>
                                                                <tfoot>
                                                                    <tr class="table-active">
                                                                        <td colspan="2" class="text-end fw-bold">Total Rows:</td>
                                                                        <td class="text-end fw-bold" id="total_rows">0</td>
                                                                    </tr>
                                                                </tfoot>
                                                            </table>
                                                        </div>
                                                    </div>
                                                    <div id="csv_loading" class="text-center my-3" style="display: none;">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                        <p class="mt-2">Counting rows, please wait...</p>
                                                    </div>
                                                    <div id="csv_error" class="alert alert-danger mt-3" style="display: none;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                    <div class="row">
                                        <div class="row mb-4">
                                            <div class="col-md-12">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <div>Search Requests</div>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col-md-5">
                                                                <div class="form-group">
                                                                    <label for="url" class="form-label">URL to test:</label>
                                                                    <input type="text" class="form-control" id="url" name="url"
                                                                           placeholder="Enter URL to search" value="{{ defaults.url }}">
                                                                </div>
                                                            </div>
                                                            <div class="col-md-5">
                                                                <div class="form-group">
                                                                    <label for="search_term" class="form-label">Search term:</label>
                                                                    <div class="input-group">
                                                                        <input type="text" class="form-control" id="search_term" name="search_term"
                                                                               placeholder="Enter search term" value="{{ defaults.search_term }}">
                                                                        <button type="button" class="btn btn-primary" id="search_requests_btn">
                                                                            <i class="bi bi-search"></i> Search
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Search Results -->
                                                        <div id="search_results" class="mt-4" style="display: none;">
                                                            <div class="alert alert-success" id="search_success" style="display: none;"></div>
                                                            <div class="alert alert-danger" id="search_error" style="display: none;"></div>
                                                            <div id="search_details" class="mt-3">
                                                                <p><strong>URL:</strong> <span id="searched_url"></span></p>
                                                                <p><strong>Status Code:</strong> <span id="status_code"></span></p>
                                                                <p><strong>Content Length:</strong> <span id="content_length"></span> bytes</p>
                                                                <p><strong>Term Found:</strong> <span id="term_found"></span></p>
                                                                <p><strong>Occurrences:</strong> <span id="occurrences"></span></p>
                                                                <div id="sample_container" class="mt-3" style="display: none;">
                                                                    <h6>List of URLs:</h6>
                                                                    <div class="p-3 bg-light rounded" id="sample_content">
                                                                        <!-- Sample content will be inserted here -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Loading Indicator -->
                                                        <div id="search_loading" class="text-center my-3" style="display: none;">
                                                            <div class="spinner-border text-primary" role="status">
                                                                <span class="visually-hidden">Loading...</span>
                                                            </div>
                                                            <p class="mt-2">Searching, please wait...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% block custom %}{% endblock custom %}
                    <button type="submit" class="btn btn-primary mt-3">Run</button>
                </form>
            </div>
        {% endblock common %}
    {% endblock scrape_content %}
    {% block scripts %}
        <script>
            {% block file_mapping %}
        // Define the file name mappings
        const fileMappings = {
            {% for category in categories %}
            "{{ category.id }}": {
                "url_file": "{{ category.url_file }}",
                "data_file": "{{ category.data_file }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        };{% endblock file_mapping %}
        // Function to update file names based on selected category
        function updateFilenames(categoryId) {
            const mapping = fileMappings[categoryId];
            if (mapping) {
                document.getElementById('url_file').value = mapping.url_file;
                document.getElementById('data_file').value = mapping.data_file;
            }
        }

        // Initialize file names on page load
        document.addEventListener('DOMContentLoaded', function() {
            const initialCategory = document.getElementById('category_id').value;
            updateFilenames(initialCategory);

            // Use event delegation for the count CSV rows button
            document.addEventListener('click', function(event) {
                // Check if the clicked element is the button or a child of the button
                const countBtn = event.target.closest('#count_csv_btn');
                if (!countBtn) return;

                console.log('Count CSV Rows button clicked');
                const directory = document.getElementById('csv_dir').value.trim();
                const resultsDiv = document.getElementById('csv_results');
                const resultsBody = document.getElementById('csv_results_body');
                const loadingDiv = document.getElementById('csv_loading');
                const errorDiv = document.getElementById('csv_error');
                const totalRowsCell = document.getElementById('total_rows');

                if (!directory) {
                    errorDiv.textContent = 'Please enter a directory path';
                    errorDiv.style.display = 'block';
                    return;
                }

                // Show loading, hide results and error
                loadingDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
                errorDiv.style.display = 'none';

                // Make AJAX request
                fetch('/scrapers/count-csv-rows/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: `directory=${encodeURIComponent(directory)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Clear previous results
                    resultsBody.innerHTML = '';
                    let totalRows = 0;
                    let totalUrlRows = 0;
                    let totalDataRows = 0;

                    // Process results
                    for (const [dirPath, dirData] of Object.entries(data.results)) {
                        // Group files by their base name (without _urls or _data suffix)
                        const fileGroups = {};

                        dirData.files.forEach(file => {
                            // Extract base name (e.g., 'products' from 'products_urls.csv' or 'products_data.csv')
                            const baseName = file.file_name.replace(/(_urls|_data)\.csv$/, '');
                            if (!fileGroups[baseName]) {
                                fileGroups[baseName] = {
                                    urlFile: null,
                                    dataFile: null,
                                    dirPath: dirPath
                                };
                            }

                            if (file.type === 'urls') {
                                fileGroups[baseName].urlFile = file;
                            } else if (file.type === 'data') {
                                fileGroups[baseName].dataFile = file;
                            }
                        });

                        // Create rows for each file group
                        Object.entries(fileGroups).forEach(([baseName, files]) => {
                            const row = document.createElement('tr');

                            // Directory column
                            const dirCell = document.createElement('td');
                            dirCell.textContent = dirPath || '.';

                            // Base name column
                            const nameCell = document.createElement('td');
                            nameCell.textContent = baseName;

                            // URL file count column
                            const urlCell = document.createElement('td');
                            if (files.urlFile) {
                                urlCell.textContent = files.urlFile.row_count.toLocaleString();
                                urlCell.className = 'text-primary text-end';
                                totalUrlRows += files.urlFile.row_count;
                            } else {
                                urlCell.textContent = '0';
                                urlCell.className = 'text-muted text-end';
                            }

                            // Data file count column
                            const dataCell = document.createElement('td');
                            if (files.dataFile) {
                                const dataCount = files.dataFile.row_count;
                                dataCell.textContent = dataCount.toLocaleString();
                                dataCell.className = 'text-end';

                                // Make text green if data count >= url count
                                const urlCount = files.urlFile ? files.urlFile.row_count : 0;
                                if (dataCount >= urlCount) {
                                    dataCell.classList.add('text-success', 'fw-bold');
                                }

                                totalDataRows += dataCount;
                            } else {
                                dataCell.textContent = '0';
                                dataCell.className = 'text-muted text-end';
                            }

                            // Add cells to row
                            row.appendChild(dirCell);
                            row.appendChild(nameCell);
                            row.appendChild(urlCell);
                            row.appendChild(dataCell);

                            resultsBody.appendChild(row);
                            totalRows += (files.urlFile?.row_count || 0) + (files.dataFile?.row_count || 0);
                        });

                        // Add summary row for this directory
                        const summaryRow = document.createElement('tr');
                        summaryRow.classList.add('table-active');

                        const summaryCell = document.createElement('td');
                        summaryCell.colSpan = 2;
                        summaryCell.textContent = 'Total';
                        summaryCell.className = 'text-end fw-bold';

                        const urlTotalCell = document.createElement('td');
                        urlTotalCell.textContent = dirData.url_rows.toLocaleString();
                        urlTotalCell.className = 'text-primary text-end fw-bold';

                        const dataTotalCell = document.createElement('td');
                        dataTotalCell.textContent = dirData.data_rows.toLocaleString();
                        dataTotalCell.className = 'text-end fw-bold';

                        // Make data total green if >= url total
                        if (dirData.data_rows >= dirData.url_rows) {
                            dataTotalCell.classList.add('text-success');
                        }

                        summaryRow.appendChild(summaryCell);
                        summaryRow.appendChild(urlTotalCell);
                        summaryRow.appendChild(dataTotalCell);
                        resultsBody.appendChild(summaryRow);
                    }

                    // Update total rows
                    totalRowsCell.textContent = totalRows.toLocaleString();
                    document.getElementById('total_url_rows').textContent = totalUrlRows.toLocaleString();
                    document.getElementById('total_data_rows').textContent = totalDataRows.toLocaleString();

                    // Update total data rows class based on comparison
                    const totalDataCell = document.getElementById('total_data_rows');
                    if (totalDataRows >= totalUrlRows) {
                        totalDataCell.classList.add('text-success', 'fw-bold');
                    } else {
                        totalDataCell.classList.remove('text-success', 'fw-bold');
                    }

                    // Show results
                    resultsDiv.style.display = 'block';
                })
                .catch(error => {
                    errorDiv.textContent = `Error: ${error.message}`;
                    errorDiv.style.display = 'block';
                })
                .finally(() => {
                    loadingDiv.style.display = 'none';
                });
            });

            // Add event listener for the update distributor button
            // Add event listener for the search requests button
            document.getElementById('search_requests_btn').addEventListener('click', function() {
                const url = document.getElementById('url').value.trim();
                const searchTerm = document.getElementById('search_term').value.trim();
                const resultsDiv = document.getElementById('search_results');
                const successDiv = document.getElementById('search_success');
                const errorDiv = document.getElementById('search_error');
                const loadingDiv = document.getElementById('search_loading');
                const detailsDiv = document.getElementById('search_details');

                // Validate inputs
                if (!url) {
                    errorDiv.textContent = 'Please enter a URL to search';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                    resultsDiv.style.display = 'block';
                    return;
                }

                if (!searchTerm) {
                    errorDiv.textContent = 'Please enter a search term';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                    resultsDiv.style.display = 'block';
                    return;
                }

                // Show loading, hide results and error
                loadingDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';

                // Make AJAX request
                fetch('/scrapers/search-requests/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: `url=${encodeURIComponent(url)}&search_term=${encodeURIComponent(searchTerm)}`
                })
                .then(response => response.json())
                .then(data => {
                    // Show results
                    resultsDiv.style.display = 'block';
                    loadingDiv.style.display = 'none';

                    if (data.success) {
                        // Update UI with results
                        document.getElementById('searched_url').textContent = data.url;
                        document.getElementById('status_code').textContent = data.status_code;
                        document.getElementById('content_length').textContent = data.content_length;
                        document.getElementById('term_found').textContent = data.found ? 'Yes' : 'No';
                        document.getElementById('occurrences').textContent = data.count;

                        // Show sample if available
                        const sampleContainer = document.getElementById('sample_container');
                        const sampleContent = document.getElementById('sample_content');
                        if (data.found && data.sample) {
                            sampleContent.innerHTML = data.sample;
                            sampleContainer.style.display = 'block';
                        } else {
                            sampleContainer.style.display = 'none';
                        }

                        // Show success message
                        successDiv.textContent = `Search completed successfully.`;
                        successDiv.style.display = 'block';
                        errorDiv.style.display = 'none';
                    } else {
                        // Show error message
                        errorDiv.textContent = data.error || 'An unknown error occurred';
                        errorDiv.style.display = 'block';
                        successDiv.style.display = 'none';
                    }
                })
                .catch(error => {
                    // Show error
                    resultsDiv.style.display = 'block';
                    loadingDiv.style.display = 'none';
                    errorDiv.textContent = `Error: ${error.message}`;
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                });
            });

            // Add event listener for the update distributor button
            document.getElementById('update_distributor_btn').addEventListener('click', function() {
                const distributorName = document.getElementById('distributor_name').value.trim();
                const homeDirectory = document.getElementById('home_directory').value.trim();
                const resultsDiv = document.getElementById('distributor_results');
                const successDiv = document.getElementById('distributor_success');
                const errorDiv = document.getElementById('distributor_error');
                const loadingDiv = document.getElementById('distributor_loading');
                const detailsDiv = document.getElementById('distributor_details');
                const errorList = document.getElementById('error_list');
                const updatedFilesCount = document.getElementById('updated_files_count');
                const totalFilesCount = document.getElementById('total_files_count');
                const errorsDiv = document.getElementById('distributor_errors');
                
                // Validate inputs
                if (!distributorName) {
                    errorDiv.textContent = 'Please enter a distributor name';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                    detailsDiv.style.display = 'none';
                    resultsDiv.style.display = 'block';
                    return;
                }
                
                if (!homeDirectory) {
                    errorDiv.textContent = 'Please enter a home directory';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                    detailsDiv.style.display = 'none';
                    resultsDiv.style.display = 'block';
                    return;
                }
                
                // Show loading, hide results and error
                loadingDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';
                detailsDiv.style.display = 'none';
                
                // Make AJAX request
                fetch('/scrapers/update-distributor/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: `directory=${encodeURIComponent(homeDirectory)}&distributor_name=${encodeURIComponent(distributorName)}`
                })
                .then(response => response.json())
                .then(data => {
                    // Show results
                    resultsDiv.style.display = 'block';
                    loadingDiv.style.display = 'none';
                    
                    if (data.success) {
                        // Show success message
                        successDiv.textContent = data.message;
                        successDiv.style.display = 'block';
                        errorDiv.style.display = 'none';
                        
                        // Show details
                        updatedFilesCount.textContent = data.files_updated || 0;
                        totalFilesCount.textContent = data.total_files || 0;
                        detailsDiv.style.display = 'block';
                        
                        // Show errors if any
                        if (data.errors && data.errors.length > 0) {
                            errorList.innerHTML = '';
                            data.errors.forEach(error => {
                                const li = document.createElement('li');
                                li.textContent = error;
                                errorList.appendChild(li);
                            });
                            errorsDiv.style.display = 'block';
                        } else {
                            errorsDiv.style.display = 'none';
                        }
                    } else {
                        // Show error message
                        errorDiv.textContent = data.error || 'An unknown error occurred';
                        errorDiv.style.display = 'block';
                        successDiv.style.display = 'none';
                        detailsDiv.style.display = 'none';
                    }
                })
                .catch(error => {
                    // Show error
                    resultsDiv.style.display = 'block';
                    loadingDiv.style.display = 'none';
                    errorDiv.textContent = `Error: ${error.message}`;
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                    detailsDiv.style.display = 'none';
                });
            });
        });
        </script>
    {% endblock scripts %}
{% endblock content %}