{% extends '../_base.html' %}

{% block content %}
    {% block scrape_content %}
        {% block common %}
            <div class="container mt-4">
                <h2>{% block name %}{% endblock name %}</h2>
                <div><a href="{{ defaults.base_url }}">Website</a></div>
                {% block top %}{% endblock top %}
                <form method="post" class="mt-4" id="scraperForm" onsubmit="return handleFormSubmit(event)">
                    {% csrf_token %}
                    <!-- Scraping Functions Card -->
                    <div class="row mt-1">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <div>Scraping Options</div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="form-group mb-3">
                                            <label for="category_id" title="Select a product category to scrape">Category:</label>
                                            <select class="form-control" id="category_id" name="category_id" required
                                                    onchange="updateFilenames(this.value)">
                                                {% for category in categories %}
                                                <option value="{{ category.id }}">{{ category.name }} ({{ category.id }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="get_categories" name="get_categories"
                                                       {% if defaults.get_categories %}checked{% endif %}>
                                                <label class="form-check-label" for="get_categories" title="Check to enable scraping of product URLs from the selected category">1. Get Categories List</label>
                                            </div>
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="scrape_products" name="scrape_products"
                                                       {% if defaults.scrape_products %}checked{% endif %}>
                                                <label class="form-check-label" for="scrape_products" title="Check to enable scraping of product URLs from the selected category">2. Get Product URLs</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="process_csv" name="process_csv"
                                                       {% if defaults.process_csv %}checked{% endif %}>
                                                <label class="form-check-label" for="process_csv" title="Process the URLs in the specified CSV file to extract product data">3. Process URLs</label>
                                            </div>
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="reprocess_csv" name="reprocess_csv"
                                                       {% if defaults.reprocess_csv %}checked{% endif %}>
                                                <label class="form-check-label" for="reprocess_csv" title="Only process URLs that haven't been processed yet (not found in results)">4. Processes URLS not in Results</label>
                                            </div>
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="process_extra" name="process_extra"
                                                       {% if defaults.process_csv %}checked{% endif %}>
                                                <label class="form-check-label" for="process_extra" title="Reprocess the data file to extract extra data">Process Extra Data</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="url_file" title="Name of the CSV file containing product URLs (will be auto-filled based on category)">URLs CSV File:</label>
                                                <input type="text" class="form-control" id="url_file" name="url_file"
                                                       value="{{ defaults.url_file }}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="data_file" title="Name of the CSV file where product data will be saved (will be auto-filled based on category)">Data CSV File:</label>
                                                <input type="text" class="form-control" id="data_file" name="data_file"
                                                       value="{{ defaults.data_file }}">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <button type="submit" class="btn btn-primary mt-3">Run</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- CSV Functions Card -->
                    <div class="row mt-1">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <div>CSV Functions</div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="dedupe_csv" name="dedupe_csv"
                                                       {% if defaults.dedupe_csv %}checked{% endif %}>
                                                <label class="form-check-label" for="dedupe_csv"
                                                       title="Remove duplicate entries from the specified CSV file (use URL Filename field)">
                                                    Dedupe a CSV
                                                </label>
                                            </div>
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="count_csv" name="count_csv"
                                                       {% if defaults.count_csv %}checked{% endif %}>
                                                <label class="form-check-label" for="count_csv"
                                                       title="Count rows in all  CSV files in the specified directory">
                                                    Count Rows in All CSVs in home directory
                                                </label>
                                            </div>
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="clean_data" name="clean_data"
                                                       {% if defaults.clean_data %}checked{% endif %}>
                                                <label class="form-check-label" for="clean_data"
                                                       title="Clean the data file by removing rows without values in the specified field">
                                                    Clean Data (remove empty rows)
                                                </label>
                                                <div class="row mt-2">
                                                    <div class="col-md-6">
                                                        <div class="input-group mb-2">
                                                            <span class="input-group-text">Field:</span>
                                                            <input type="text" class="form-control" id="clean_field" name="clean_field"
                                                                   value="{{ defaults.clean_field|default:'name' }}"
                                                                   placeholder="Field name (e.g., name, sku)">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" name="file_type" id="clean_url_file"
                                                                   value="url" checked>
                                                            <label class="form-check-label" for="clean_url_file">
                                                                URL File
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" name="file_type" id="clean_data_file"
                                                                   value="data">
                                                            <label class="form-check-label" for="clean_data_file">
                                                                Data File
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-primary mt-3">Run</button>
                                        </div>
                                        <div class="col-md-6">
{#                                            <div class="form-group">#}
{#                                                <label for="distributor_name" class="form-label">Distributor Name:</label>#}
{#                                                <div class="input-group">#}
{#                                                    <input type="text" class="form-control" id="distributor_name"#}
{#                                                           placeholder="Enter distributor name">#}
{#                                                    <button class="btn btn-outline-secondary" type="button"#}
{#                                                            id="#test">#}
{#                                                        Update All CSVs#}
{#                                                    </button>#}
{#                                                </div>#}
{#                                                <small class="form-text text-muted">#}
{#                                                    Updates the 'distributor_name' column in all CSV files in the home directory.#}
{#                                                </small>#}
{#                                            </div>#}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- General Configuration Card -->
                    <div class="row mt-1">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <div>General Configuration</div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="home_directory" title="Base directory where files will be saved (defaults to current directory)">Home Directory:</label>
                                                <input type="text" class="form-control" id="home_directory" name="home_directory"
                                                       value="{{ defaults.home_directory|default:'.' }}" placeholder="Enter home directory path">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="max_products" title="Maximum number of products to request from the API in a single call">Max Products to Force in API Call:</label>
                                                <input type="number" class="form-control" id="max_products" name="max_products"
                                                       value="{{ defaults.max_products }}" min="1">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Testing Card -->
                    <div class="row mt-1">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <div>Target a specific category or row</div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="start_row" title="Start processing from this row number (0-based index)">Start Row:</label>
                                                <input type="number" class="form-control" id="start_row" name="start_row"
                                                       value="{{ defaults.start_row }}" min="0">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="category_to_process" title="Process only this specific category (0 = process all categories)">Category to Process: </label>
                                                <input type="number" class="form-control" id="category_to_process" name="category_to_process"
                                                       value="{{ defaults.category_to_process }}" min="0">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="test_products" title="Maximum number of products to scrape (for testing purposes)">Number of Products to Scrape:</label>
                                <input type="number" class="form-control" id="test_products" name="test_products"
                                       value="{{ defaults.test_products }}" min="1">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="test_categories" title="Maximum number of categories to process (for testing purposes)">Number of Categories to Scrape:</label>
                                <input type="number" class="form-control" id="test_categories" name="test_categories"
                                       value="{{ defaults.test_categories }}" min="1">
                            </div>
                        </div>
                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Utilities Card -->
                    <div class="row mt-1">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <div>Utilities</div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="row mb-4">
                                            <div class="col-md-12">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <div>Update Distributor Name</div>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col-md-8">
                                                                <div class="form-group">
                                                                    <label for="distributor_name" class="form-label">Distributor Name:</label>
                                                                    <div class="input-group">
                                                                        <input type="text" class="form-control" id="distributor_name"
                                                                               placeholder="Enter distributor name">
                                                                        <button type="button" class="btn btn-primary" id="update_distributor_btn">
                                                                            <i class="bi bi-tag"></i> Update Distributor
                                                                        </button>
                                                                    </div>
                                                                    <small class="form-text text-muted">
                                                                        This will update/add the 'distributor_name' column in all CSV files in the home directory.
                                                                    </small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div id="distributor_results" class="mt-3" style="display: none;">
                                                            <div class="alert alert-success" id="distributor_success" style="display: none;"></div>
                                                            <div class="alert alert-danger" id="distributor_error" style="display: none;"></div>
                                                            <div id="distributor_details" style="display: none;">
                                                                <p class="mb-1"><strong>Updated files:</strong> <span id="updated_files_count">0</span></p>
                                                                <p class="mb-1"><strong>Total files processed:</strong> <span id="total_files_count">0</span></p>
                                                                <div id="distributor_errors" class="mt-2" style="display: none;">
                                                                    <h6>Errors:</h6>
                                                                    <ul id="error_list" class="text-danger small"></ul>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div id="distributor_loading" class="text-center my-3" style="display: none;">
                                                            <div class="spinner-border text-primary" role="status">
                                                                <span class="visually-hidden">Loading...</span>
                                                            </div>
                                                            <p class="mt-2">Updating distributor names, please wait...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                        <div class="col-md-12">
                                            <div class="card mb-4">
                                                <div class="card-header">
                                                    <div>CSV Row Counter</div>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-8">
                                                            <div class="form-group">
                                                                <label for="csv_dir" class="form-label">Directory to Scan:</label>
                                                                <div class="input-group">
                                                                    <input type="text" class="form-control" id="csv_dir" name="csv_dir"
                                                                           placeholder="Enter directory path" value="{{ defaults.home_directory|default:'.' }}">
                                                                    <button type="button" class="btn btn-primary" id="count_csv_btn">
                                                                        <i class="bi bi-calculator"></i> Count Rows</button>
                                                                </div>
                                                                <small class="form-text text-muted">
                                                                    Will scan all subdirectories for CSV files containing 'data' in their names.
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div id="csv_results" class="mt-3" style="display: none;">
                                                        <div class="table-responsive">
                                                            <table class="table table-sm table-striped">
                                                                <thead class="table-light">
                                                                    <tr>
                                                                        <th>Directory</th>
                                                                        <th>File</th>
                                                                        <th class="text-end">Rows</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="csv_results_body">
                                                                    <!-- Results will be inserted here by JavaScript -->
                                                                </tbody>
                                                                <tfoot>
                                                                    <tr class="table-active">
                                                                        <td colspan="2" class="text-end fw-bold">Total Rows:</td>
                                                                        <td class="text-end fw-bold" id="total_rows">0</td>
                                                                    </tr>
                                                                </tfoot>
                                                            </table>
                                                        </div>
                                                    </div>
                                                    <div id="csv_loading" class="text-center my-3" style="display: none;">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                        <p class="mt-2">Counting rows, please wait...</p>
                                                    </div>
                                                    <div id="csv_error" class="alert alert-danger mt-3" style="display: none;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                    <div class="row">
                                        <div class="row mb-4">
                                            <div class="col-md-12">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <div>Search Requests</div>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col-md-5">
                                                                <div class="form-group">
                                                                    <label for="url" class="form-label">URL to test:</label>
                                                                    <input type="text" class="form-control" id="url" name="url"
                                                                           placeholder="Enter URL to search" value="{{ defaults.url }}">
                                                                </div>
                                                            </div>
                                                            <div class="col-md-5">
                                                                <div class="form-group">
                                                                    <label for="search_term" class="form-label">Search term:</label>
                                                                    <div class="input-group">
                                                                        <input type="text" class="form-control" id="search_term" name="search_term"
                                                                               placeholder="Enter search term" value="{{ defaults.search_term }}">
                                                                        <button type="button" class="btn btn-primary" id="search_requests_btn">
                                                                            <i class="bi bi-search"></i> Search
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Search Results -->
                                                        <div id="search_results" class="mt-4" style="display: none;">
                                                            <div class="alert alert-success" id="search_success" style="display: none;"></div>
                                                            <div class="alert alert-danger" id="search_error" style="display: none;"></div>
                                                            <div id="search_details" class="mt-3">
                                                                <p><strong>URL:</strong> <span id="searched_url"></span></p>
                                                                <p><strong>Status Code:</strong> <span id="status_code"></span></p>
                                                                <p><strong>Content Length:</strong> <span id="content_length"></span> bytes</p>
                                                                <p><strong>Term Found:</strong> <span id="term_found"></span></p>
                                                                <p><strong>Occurrences:</strong> <span id="occurrences"></span></p>
                                                                <div id="sample_container" class="mt-3" style="display: none;">
                                                                    <h6>List of URLs:</h6>
                                                                    <div class="p-3 bg-light rounded" id="sample_content">
                                                                        <!-- Sample content will be inserted here -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Loading Indicator -->
                                                        <div id="search_loading" class="text-center my-3" style="display: none;">
                                                            <div class="spinner-border text-primary" role="status">
                                                                <span class="visually-hidden">Loading...</span>
                                                            </div>
                                                            <p class="mt-2">Searching, please wait...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% block custom %}{% endblock custom %}
                    <button type="submit" class="btn btn-primary mt-3">Run</button>
                </form>
            </div>
            <!-- Progress Modal -->
            <div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true" data-bs-backdrop="static">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="progressModalLabel">Processing Products</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="progressError" class="alert alert-danger d-none" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <span id="progressErrorMessage"></span>
                            </div>

                            <div id="progressContent">
                                <div class="d-flex justify-content-between mb-2">
                                    <span id="statusText">Starting...</span>
                                    <span id="progressText">0%</span>
                                </div>
                                <div class="progress mb-3" style="height: 25px;">
                                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div id="stopButtonContainer" class="text-center mb-3">
                                    <button id="stopTaskBtn" class="btn btn-danger">
                                        <i class="fas fa-stop-circle me-1"></i> Stop Task
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <p class="mb-1"><small class="text-muted">Processed:</small> <span id="processedCount">0</span> / <span id="totalCount">0</span></p>
                                    <p class="mb-1"><small class="text-muted">Current:</small> <span id="currentItem">-</span></p>
                                    <p class="mb-0"><small class="text-muted">Errors:</small> <span id="errorCount" class="text-danger">0</span></p>
                                </div>
                                <div id="skuLists" class="d-none">
                                    <h6>Processed SKUs:</h6>
                                    <ul id="processedSkusList" class="list-group list-group-flush"></ul>
                                    <h6>Not Found SKUs:</h6>
                                    <ul id="notFoundSkusList" class="list-group list-group-flush"></ul>
                                </div>
                                <div id="currentSkuContainer" class="d-none">
                                    <h6>Current SKU:</h6>
                                    <p id="currentSku"></p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        {% endblock common %}
    {% endblock scrape_content %}
    {% block scripts %}
        <script>
            {% block file_mapping %}
                // Define the file name mappings
                const fileMappings = {
                    {% for category in categories %}
                    "{{ category.id }}": {
                        "url_file": "{{ category.url_file }}",
                        "data_file": "{{ category.data_file }}"
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                };
        {% endblock file_mapping %}
            // Global variable to track the progress polling
    let progressInterval = null;
    let currentTaskId = null;
    let isStopped = false; // Track if the task was stopped by the user

    // Function to update the favicon
    function updateFavicon(icon) {
        let link = document.querySelector("link[rel*='icon']") || document.createElement('link');
        link.type = 'image/x-icon';
        link.rel = 'icon';

        if (icon === 'spinner') {
            // Spinner SVG (rotating circle)
            link.href = 'data:image/svg+xml,' +
                encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">' +
                    '<circle cx="50" cy="50" r="45" fill="none" stroke="#0d6efd" stroke-width="10" ' +
                    'stroke-dasharray="212.0575 70.6858" transform="rotate(0 50 50)">' +
                    '<animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" ' +
                    'dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg>');
        } else if (icon === 'check') {
            // Checkmark SVG
            link.href = 'data:image/svg+xml,' +
                encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">' +
                    '<path fill="#198754" d="M38 80L10 52l8-8 20 20 40-40 8 8z"></path></svg>');
        } else if (icon === 'default') {
            // Default favicon (can be customized)
            link.href = '/favicon.ico';
        }

        // Remove existing favicon if it exists
        const oldLink = document.querySelector("link[rel*='icon']");
        if (oldLink) {
            oldLink.remove();
        }

        // Add the new favicon
        document.getElementsByTagName('head')[0].appendChild(link);
    }

    // Function to show the progress modal
    function showProgressModal(taskId) {
        currentTaskId = taskId;
        isStopped = false;
        const modal = new bootstrap.Modal(document.getElementById('progressModal'));
        modal.show();
        updateFavicon('spinner'); // Set spinner favicon when progress starts
        startProgressPolling();

        // Enable stop button
        const stopBtn = document.getElementById('stopTaskBtn');
        if (stopBtn) {
            stopBtn.disabled = false;
            stopBtn.innerHTML = '<i class="fas fa-stop-circle me-1"></i> Stop Task';
        }
    }

    // Function to start polling for progress updates
    function startProgressPolling() {
        // Clear any existing interval
        if (progressInterval) {
            clearInterval(progressInterval);
        }

        // Start polling every second
        progressInterval = setInterval(updateProgress, 3000);
    }

    // Function to stop the current task
    function stopCurrentTask() {
        if (!currentTaskId || isStopped) return;

        isStopped = true;
        const stopBtn = document.getElementById('stopTaskBtn');
        if (stopBtn) {
            stopBtn.disabled = true;
            stopBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Stopping...';
        }

        fetch('/api/stop_processing/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFTOKEN': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ task_id: currentTaskId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showProgressError('Task was stopped by user');
                updateFavicon('default');
            } else {
                showProgressError(data.error || 'Failed to stop task');
            }

            // Clear the interval to stop polling
            clearInterval(progressInterval);
            progressInterval = null;

            // Re-enable the stop button with original text
            if (stopBtn) {
                stopBtn.disabled = false;
                stopBtn.innerHTML = '<i class="fas fa-stop-circle me-1"></i> Stop Task';
            }
        })
        .catch(error => {
            console.error('Error stopping task:', error);
            showProgressError('Error stopping task');
        });
    }

    // Function to update progress
    function updateProgress() {
        if (!currentTaskId || isStopped) return;

        fetch('{% url "get_processing_progress" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFTOKEN': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ task_id: currentTaskId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showProgressError(data.error);
                return;
            }

            const progress = data.progress;
            if (!progress) return;

            // Update progress bar - handle both regular progress and missing SKUs progress
            let progressPercent = 0;
            if (progress.total > 0) {
                progressPercent = progress.current_sku ?
                    Math.round((progress.processed_skus.length / progress.total) * 100) :
                    Math.round((progress.current / progress.total) * 100);
            }

            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${progressPercent}%`;

            // Update status text
            let statusText = 'Processing...';
            if (progress.status === 'completed') {
                statusText = 'Processing Complete!';
            } else if (progress.status === 'error') {
                statusText = 'Error Occurred';
            } else if (progress.status === 'stopped') {
                statusText = 'Stopped by User';
            }
            document.getElementById('statusText').textContent = statusText;

            // Update counts and current item
            if (progress.current_sku !== undefined) {
                // For process_missing_skus task
                document.getElementById('currentItem').textContent = progress.current_sku || '-';
                document.getElementById('processedCount').textContent = progress.processed_skus ? progress.processed_skus.length : 0;
                document.getElementById('totalCount').textContent = progress.total || 0;
                document.getElementById('errorCount').textContent = progress.not_found_skus ? progress.not_found_skus.length : 0;

                // Update the current SKU being processed
                if (progress.current_sku) {
                    document.getElementById('currentSkuContainer').classList.remove('d-none');
                    document.getElementById('currentSku').textContent = progress.current_sku;
                }

                // Show/hide the SKU lists
                const skuLists = document.getElementById('skuLists');
                if (progress.processed_skus?.length > 0 || progress.not_found_skus?.length > 0) {
                    skuLists.classList.remove('d-none');

                    // Update processed SKUs list
                    const processedList = document.getElementById('processedSkusList');
                    if (progress.processed_skus?.length > 0) {
                        processedList.innerHTML = progress.processed_skus
                            .map(sku => `<li class="list-group-item py-1">${sku}</li>`)
                            .join('');
                    } else {
                        processedList.innerHTML = '<li class="list-group-item py-1 text-muted">No SKUs processed yet</li>';
                    }

                    // Update not found SKUs list
                    const notFoundList = document.getElementById('notFoundSkusList');
                    if (progress.not_found_skus?.length > 0) {
                        notFoundList.innerHTML = progress.not_found_skus
                            .map(sku => `<li class="list-group-item py-1 text-danger">${sku}</li>`)
                            .join('');
                    } else {
                        notFoundList.innerHTML = '<li class="list-group-item py-1 text-muted">All SKUs found</li>';
                    }
                } else {
                    skuLists.classList.add('d-none');
                }
            } else {
                // For regular progress
                document.getElementById('currentItem').textContent = progress.current_product || '-';
                document.getElementById('processedCount').textContent = progress.processed || 0;
                document.getElementById('totalCount').textContent = progress.total || 0;
                document.getElementById('errorCount').textContent = progress.errors || 0;
            }

            // Handle completion or errors
            if (progress.status === 'completed' || progress.status === 'error' || progress.status === 'stopped') {
                clearInterval(progressInterval);
                progressInterval = null;

                // Update favicon based on status
                if (progress.status === 'completed') {
                    updateFavicon('check');
                } else if (progress.status === 'error') {
                    showProgressError(progress.error || 'An unknown error occurred');
                } else if (progress.status === 'stopped') {
                    updateFavicon('default');
                }
            }
        })
        .catch(error => {
            console.error('Error fetching progress:', error);
            showProgressError('Failed to fetch progress updates');
        });
    }

    // Function to show error in progress modal
    function showProgressError(message) {
        clearInterval(progressInterval);
        progressInterval = null;

        document.getElementById('progressErrorMessage').textContent = message;
        document.getElementById('progressError').classList.remove('d-none');
        document.getElementById('progressContent').classList.add('d-none');
    }

    // Add event listener for the stop button
    document.addEventListener('DOMContentLoaded', function() {
        const stopBtn = document.getElementById('stopTaskBtn');
        if (stopBtn) {
            stopBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to stop the current task?')) {
                    stopCurrentTask();
                }
            });
        }
    });

    // Close modal handler
    document.getElementById('progressModal').addEventListener('hidden.bs.modal', function () {
        clearInterval(progressInterval);
        progressInterval = null;
        currentTaskId = null;
        isStopped = false;
        // Reset favicon when modal is closed
        updateFavicon('default');
    });

        // Function to handle form submission
        function handleFormSubmit(event) {
            const form = event.target;
            const processCsvChecked = document.getElementById('process_csv').checked;
            const reprocessCsvChecked = document.getElementById('reprocess_csv').checked;

            if (processCsvChecked || reprocessCsvChecked) {
                // Prevent default form submission
                event.preventDefault();
                console.log('Processing CSV...');
                // Show loading state
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Starting...';
                
                // Submit form data via fetch
                const formData = new FormData(form);
                
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.task_id) {
                        // Show progress modal with the task ID
                        showProgressModal(data.task_id);
                        console.log('showProgressModal...');
                    } else if (data.redirect_url) {
                        // If no task_id but has redirect_url, redirect to that URL
                        window.location.href = data.redirect_url;
                        console.log('redirect...');
                    } else {
                        // Fallback to default form submission
                        form.submit();
                        console.log('submit...');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Fallback to default form submission on error
                    form.submit();
                })
                .finally(() => {
                    // Reset button state
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                });
                
                return false;
            }
            
            // Default form submission for non-CSV processing
            return true;
        }
        
        // Function to update file names based on selected category
        function updateFilenames(categoryId) {
            const mapping = fileMappings[categoryId];
            if (mapping) {
                document.getElementById('url_file').value = mapping.url_file;
                document.getElementById('data_file').value = mapping.data_file;
            }
        }


        // Initialize file names on page load
        document.addEventListener('DOMContentLoaded', function() {
            const initialCategory = document.getElementById('category_id').value;
            updateFilenames(initialCategory);

            // Handle checkbox behavior - only allow one checkbox to be checked at a time
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        // Uncheck all other checkboxes when one is checked
                        document.querySelectorAll('input[type="checkbox"]').forEach(otherCheckbox => {
                            if (otherCheckbox !== this) {
                                otherCheckbox.checked = false;
                            }
                        });
                    }
                });
            });

            // Use event delegation for the count CSV rows button
            document.addEventListener('click', function(event) {
                // Check if the clicked element is the button or a child of the button
                const countBtn = event.target.closest('#count_csv_btn');
                if (!countBtn) return;

                console.log('Count CSV Rows button clicked');
                const directory = document.getElementById('csv_dir').value.trim();
                const resultsDiv = document.getElementById('csv_results');
                const resultsBody = document.getElementById('csv_results_body');
                const loadingDiv = document.getElementById('csv_loading');
                const errorDiv = document.getElementById('csv_error');
                const totalRowsCell = document.getElementById('total_rows');

                if (!directory) {
                    errorDiv.textContent = 'Please enter a directory path';
                    errorDiv.style.display = 'block';
                    return;
                }

                // Show loading, hide results and error
                loadingDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
                errorDiv.style.display = 'none';

                // Make AJAX request
                fetch('/scrapers/count-csv-rows/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: `directory=${encodeURIComponent(directory)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Clear previous results
                    resultsBody.innerHTML = '';
                    let totalRows = 0;
                    let totalUrlRows = 0;
                    let totalDataRows = 0;

                    // Process results
                    for (const [dirPath, dirData] of Object.entries(data.results)) {
                        // Group files by their base name (without _urls or _data suffix)
                        const fileGroups = {};

                        dirData.files.forEach(file => {
                            // Extract base name (e.g., 'products' from 'products_urls.csv' or 'products_data.csv')
                            const baseName = file.file_name.replace(/(_urls|_data)\.csv$/, '');
                            if (!fileGroups[baseName]) {
                                fileGroups[baseName] = {
                                    urlFile: null,
                                    dataFile: null,
                                    dirPath: dirPath
                                };
                            }

                            if (file.type === 'urls') {
                                fileGroups[baseName].urlFile = file;
                            } else if (file.type === 'data') {
                                fileGroups[baseName].dataFile = file;
                            }
                        });

                        // Create rows for each file group
                        Object.entries(fileGroups).forEach(([baseName, files]) => {
                            const row = document.createElement('tr');

                            // Directory column
                            const dirCell = document.createElement('td');
                            dirCell.textContent = dirPath || '.';

                            // Base name column
                            const nameCell = document.createElement('td');
                            nameCell.textContent = baseName;

                            // URL file count column
                            const urlCell = document.createElement('td');
                            if (files.urlFile) {
                                urlCell.textContent = files.urlFile.row_count.toLocaleString();
                                urlCell.className = 'text-primary text-end';
                                totalUrlRows += files.urlFile.row_count;
                            } else {
                                urlCell.textContent = '0';
                                urlCell.className = 'text-muted text-end';
                            }

                            // Data file count column
                            const dataCell = document.createElement('td');
                            if (files.dataFile) {
                                const dataCount = files.dataFile.row_count;
                                dataCell.textContent = dataCount.toLocaleString();
                                dataCell.className = 'text-end';

                                // Make text green if data count >= url count
                                const urlCount = files.urlFile ? files.urlFile.row_count : 0;
                                if (dataCount >= urlCount) {
                                    dataCell.classList.add('text-success', 'fw-bold');
                                }

                                totalDataRows += dataCount;
                            } else {
                                dataCell.textContent = '0';
                                dataCell.className = 'text-muted text-end';
                            }

                            // Add cells to row
                            row.appendChild(dirCell);
                            row.appendChild(nameCell);
                            row.appendChild(urlCell);
                            row.appendChild(dataCell);

                            resultsBody.appendChild(row);
                            totalRows += (files.urlFile?.row_count || 0) + (files.dataFile?.row_count || 0);
                        });

                        // Add summary row for this directory
                        const summaryRow = document.createElement('tr');
                        summaryRow.classList.add('table-active');

                        const summaryCell = document.createElement('td');
                        summaryCell.colSpan = 2;
                        summaryCell.textContent = 'Total';
                        summaryCell.className = 'text-end fw-bold';

                        const urlTotalCell = document.createElement('td');
                        urlTotalCell.textContent = dirData.url_rows.toLocaleString();
                        urlTotalCell.className = 'text-primary text-end fw-bold';

                        const dataTotalCell = document.createElement('td');
                        dataTotalCell.textContent = dirData.data_rows.toLocaleString();
                        dataTotalCell.className = 'text-end fw-bold';

                        // Make data total green if >= url total
                        if (dirData.data_rows >= dirData.url_rows) {
                            dataTotalCell.classList.add('text-success');
                        }

                        summaryRow.appendChild(summaryCell);
                        summaryRow.appendChild(urlTotalCell);
                        summaryRow.appendChild(dataTotalCell);
                        resultsBody.appendChild(summaryRow);
                    }

                    // Update total rows
                    totalRowsCell.textContent = totalRows.toLocaleString();
                    document.getElementById('total_url_rows').textContent = totalUrlRows.toLocaleString();
                    document.getElementById('total_data_rows').textContent = totalDataRows.toLocaleString();

                    // Update total data rows class based on comparison
                    const totalDataCell = document.getElementById('total_data_rows');
                    if (totalDataRows >= totalUrlRows) {
                        totalDataCell.classList.add('text-success', 'fw-bold');
                    } else {
                        totalDataCell.classList.remove('text-success', 'fw-bold');
                    }

                    // Show results
                    resultsDiv.style.display = 'block';
                })
                .catch(error => {
                    errorDiv.textContent = `Error: ${error.message}`;
                    errorDiv.style.display = 'block';
                })
                .finally(() => {
                    loadingDiv.style.display = 'none';
                });
            });

            // Add event listener for the update distributor button
            // Add event listener for the search requests button
            document.getElementById('search_requests_btn').addEventListener('click', function() {
                const url = document.getElementById('url').value.trim();
                const searchTerm = document.getElementById('search_term').value.trim();
                const resultsDiv = document.getElementById('search_results');
                const successDiv = document.getElementById('search_success');
                const errorDiv = document.getElementById('search_error');
                const loadingDiv = document.getElementById('search_loading');
                const detailsDiv = document.getElementById('search_details');

                // Validate inputs
                if (!url) {
                    errorDiv.textContent = 'Please enter a URL to search';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                    resultsDiv.style.display = 'block';
                    return;
                }

                if (!searchTerm) {
                    errorDiv.textContent = 'Please enter a search term';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                    resultsDiv.style.display = 'block';
                    return;
                }

                // Show loading, hide results and error
                loadingDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';

                // Make AJAX request
                fetch('/scrapers/search-requests/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: `url=${encodeURIComponent(url)}&search_term=${encodeURIComponent(searchTerm)}`
                })
                .then(response => response.json())
                .then(data => {
                    // Show results
                    resultsDiv.style.display = 'block';
                    loadingDiv.style.display = 'none';

                    if (data.success) {
                        // Update UI with results
                        document.getElementById('searched_url').textContent = data.url;
                        document.getElementById('status_code').textContent = data.status_code;
                        document.getElementById('content_length').textContent = data.content_length;
                        document.getElementById('term_found').textContent = data.found ? 'Yes' : 'No';
                        document.getElementById('occurrences').textContent = data.count;

                        // Show sample if available
                        const sampleContainer = document.getElementById('sample_container');
                        const sampleContent = document.getElementById('sample_content');
                        if (data.found && data.sample) {
                            sampleContent.innerHTML = data.sample;
                            sampleContainer.style.display = 'block';
                        } else {
                            sampleContainer.style.display = 'none';
                        }

                        // Show success message
                        successDiv.textContent = `Search completed successfully.`;
                        successDiv.style.display = 'block';
                        errorDiv.style.display = 'none';
                    } else {
                        // Show error message
                        errorDiv.textContent = data.error || 'An unknown error occurred';
                        errorDiv.style.display = 'block';
                        successDiv.style.display = 'none';
                    }
                })
                .catch(error => {
                    // Show error
                    resultsDiv.style.display = 'block';
                    loadingDiv.style.display = 'none';
                    errorDiv.textContent = `Error: ${error.message}`;
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                });
            });

            // Add event listener for the update distributor button
            document.getElementById('update_distributor_btn').addEventListener('click', function() {
                const distributorName = document.getElementById('distributor_name').value.trim();
                const homeDirectory = document.getElementById('home_directory').value.trim();
                const resultsDiv = document.getElementById('distributor_results');
                const successDiv = document.getElementById('distributor_success');
                const errorDiv = document.getElementById('distributor_error');
                const loadingDiv = document.getElementById('distributor_loading');
                const detailsDiv = document.getElementById('distributor_details');
                const errorList = document.getElementById('error_list');
                const updatedFilesCount = document.getElementById('updated_files_count');
                const totalFilesCount = document.getElementById('total_files_count');
                const errorsDiv = document.getElementById('distributor_errors');
                
                // Validate inputs
                if (!distributorName) {
                    errorDiv.textContent = 'Please enter a distributor name';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                    detailsDiv.style.display = 'none';
                    resultsDiv.style.display = 'block';
                    return;
                }
                
                if (!homeDirectory) {
                    errorDiv.textContent = 'Please enter a home directory';
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                    detailsDiv.style.display = 'none';
                    resultsDiv.style.display = 'block';
                    return;
                }
                
                // Show loading, hide results and error
                loadingDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';
                detailsDiv.style.display = 'none';
                
                // Make AJAX request
                fetch('/scrapers/update-distributor/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: `directory=${encodeURIComponent(homeDirectory)}&distributor_name=${encodeURIComponent(distributorName)}`
                })
                .then(response => response.json())
                .then(data => {
                    // Show results
                    resultsDiv.style.display = 'block';
                    loadingDiv.style.display = 'none';
                    
                    if (data.success) {
                        // Show success message
                        successDiv.textContent = data.message;
                        successDiv.style.display = 'block';
                        errorDiv.style.display = 'none';
                        
                        // Show details
                        updatedFilesCount.textContent = data.files_updated || 0;
                        totalFilesCount.textContent = data.total_files || 0;
                        detailsDiv.style.display = 'block';
                        
                        // Show errors if any
                        if (data.errors && data.errors.length > 0) {
                            errorList.innerHTML = '';
                            data.errors.forEach(error => {
                                const li = document.createElement('li');
                                li.textContent = error;
                                errorList.appendChild(li);
                            });
                            errorsDiv.style.display = 'block';
                        } else {
                            errorsDiv.style.display = 'none';
                        }
                    } else {
                        // Show error message
                        errorDiv.textContent = data.error || 'An unknown error occurred';
                        errorDiv.style.display = 'block';
                        successDiv.style.display = 'none';
                        detailsDiv.style.display = 'none';
                    }
                })
                .catch(error => {
                    // Show error
                    resultsDiv.style.display = 'block';
                    loadingDiv.style.display = 'none';
                    errorDiv.textContent = `Error: ${error.message}`;
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                    detailsDiv.style.display = 'none';
                });
            });
        });
        </script>
    {% endblock scripts %}
{% endblock content %}